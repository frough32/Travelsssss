<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Mood - æ—…éŠè¦åŠƒ</title>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
        }
        /* éš±è— Scrollbar ä½†ä¿æŒæ»‘å‹•åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* æ¨¡æ“¬ App å®¹å™¨ */
        .app-container {
            max-width: 480px; /* æ‰‹æ©Ÿå¯¬åº¦æ¨¡æ“¬ */
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .glass-tab {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        /* é¡è‰²ä¸»é¡Œè®Šæ•¸ (ç”± Vue æ§åˆ¶) */
        .theme-text { color: var(--theme-color); }
        .theme-bg { background-color: var(--theme-color); }
        .theme-border { border-color: var(--theme-color); }
        .theme-bg-light { background-color: var(--theme-color-light); }
        
        /* è½‰å ´å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- ================= åˆå§‹è¨­å®š Modal (ç¬¬ä¸€æ¬¡é€²å…¥é¡¯ç¤º) ================= -->
    <div v-if="showSetupModal" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-6 space-y-6">
        <h1 class="text-2xl font-bold text-gray-700 mb-4">{{ setupSteps[currentStep].title }}</h1>
        
        <!-- Step 1: åœ°é» -->
        <div v-if="currentStep === 0" class="w-full">
            <input v-model="tempData.location" type="text" placeholder="è¼¸å…¥æ—…éŠåœ°é» (ä¾‹ï¼šäº¬éƒ½)" class="w-full p-4 bg-gray-100 rounded-xl text-lg focus:outline-none focus:ring-2 focus:ring-gray-300 transition">
        </div>

        <!-- Step 2: æ—¥æœŸ -->
        <div v-if="currentStep === 1" class="w-full space-y-4">
            <div>
                <label class="text-sm text-gray-500 block mb-1">å‡ºç™¼æ—¥æœŸ</label>
                <input v-model="tempData.startDate" type="date" class="w-full p-3 bg-gray-100 rounded-xl">
            </div>
            <div>
                <label class="text-sm text-gray-500 block mb-1">å›ç¨‹æ—¥æœŸ</label>
                <input v-model="tempData.endDate" :min="tempData.startDate" type="date" class="w-full p-3 bg-gray-100 rounded-xl">
            </div>
        </div>

        <!-- Step 3: èˆªç­ -->
        <div v-if="currentStep === 2" class="w-full space-y-4 overflow-y-auto max-h-[60vh]">
            <h3 class="font-bold text-gray-600">å»ç¨‹</h3>
            <input v-model="tempData.flight.outAirline" placeholder="èˆªç©ºå…¬å¸" class="w-full p-3 bg-gray-100 rounded-xl">
            <input v-model="tempData.flight.outCode" placeholder="èˆªç­ç·¨è™Ÿ (ä¾‹: JX800)" class="w-full p-3 bg-gray-100 rounded-xl">
            <div class="flex gap-2">
                <input v-model="tempData.flight.outTime" type="time" class="w-full p-3 bg-gray-100 rounded-xl">
            </div>

            <h3 class="font-bold text-gray-600 mt-4">å›ç¨‹</h3>
            <input v-model="tempData.flight.retAirline" placeholder="èˆªç©ºå…¬å¸" class="w-full p-3 bg-gray-100 rounded-xl">
            <input v-model="tempData.flight.retCode" placeholder="èˆªç­ç·¨è™Ÿ (ä¾‹: JX801)" class="w-full p-3 bg-gray-100 rounded-xl">
            <div class="flex gap-2">
                <input v-model="tempData.flight.retTime" type="time" class="w-full p-3 bg-gray-100 rounded-xl">
            </div>
        </div>

        <!-- Step 4: é¡è‰² -->
        <div v-if="currentStep === 3" class="w-full grid grid-cols-5 gap-3">
            <button v-for="color in colorOptions" :key="color.hex" 
                @click="tempData.themeColor = color"
                class="w-12 h-12 rounded-full shadow-md transform transition active:scale-95 border-2"
                :class="tempData.themeColor.hex === color.hex ? 'border-gray-600 scale-110' : 'border-transparent'"
                :style="{ backgroundColor: color.hex }">
            </button>
        </div>

        <button @click="nextStep" class="w-full py-4 rounded-xl bg-gray-800 text-white font-bold text-lg shadow-lg hover:bg-gray-700 transition">
            {{ currentStep === 3 ? 'å®Œæˆè¨­å®š' : 'ä¸‹ä¸€æ­¥' }}
        </button>
    </div>

    <!-- ================= ä¸»è¦ App ä»‹é¢ ================= -->
    <div v-else class="flex flex-col h-full relative">
        
        <!-- é é¦– Banner -->
        <header class="relative pt-8 pb-16 px-6 text-white transition-colors duration-500 rounded-b-[40px] shadow-lg z-10" :style="{ backgroundColor: tripData.themeColor.hex }">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h2 class="text-sm opacity-80 tracking-widest uppercase">Trip to</h2>
                    <h1 class="text-4xl font-bold mb-1">{{ tripData.location }}</h1>
                    <p class="text-sm opacity-90"><i class="far fa-calendar-alt mr-2"></i>{{ formatDateRange }}</p>
                </div>
                <button @click="openSettings" class="text-white opacity-70 hover:opacity-100"><i class="fas fa-cog"></i></button>
            </div>

            <!-- TAB æŒ‰éˆ• (æµ®åœ¨ Header å³ä¸‹æ–¹) -->
            <div class="absolute bottom-4 right-6 flex gap-3 z-20">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="currentTab = tab.id"
                    class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 backdrop-blur-sm"
                    :class="currentTab === tab.id ? 'bg-white text-[var(--theme-color)] scale-110' : 'bg-white/30 text-white hover:bg-white/50'"
                    :style="currentTab === tab.id ? { color: tripData.themeColor.hex } : {}">
                    <i :class="tab.icon"></i>
                </button>
            </div>
        </header>

        <!-- å…§å®¹å€åŸŸ (æœ‰ Scroll) -->
        <main class="flex-1 overflow-y-auto bg-gray-50 pb-20 hide-scrollbar scroll-smooth" id="main-content">
            
            <!-- 1. æ¯æ—¥è¡Œç¨‹è¡¨ View -->
            <div v-if="currentTab === 'itinerary'" class="p-4 space-y-6">
                <!-- æ—¥æœŸæ»‘å‹•é¸å–® -->
                <div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x">
                    <button v-for="(day, index) in dayList" :key="index"
                        @click="selectedDateIndex = index"
                        class="snap-start flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl border transition-all duration-300"
                        :class="selectedDateIndex === index ? 'bg-white shadow-md border-transparent ring-2 ring-offset-1' : 'bg-gray-100 text-gray-400 border-transparent'"
                        :style="selectedDateIndex === index ? { ringColor: tripData.themeColor.hex } : {}">
                        <span class="text-xs font-bold">{{ day.weekDay }}</span>
                        <span class="text-xl font-bold" :class="selectedDateIndex === index ? 'theme-text' : ''" :style="{ color: selectedDateIndex === index ? tripData.themeColor.hex : '' }">{{ day.dayNum }}</span>
                    </button>
                </div>

                <!-- å¤©æ°£è³‡è¨Šå¡ (Mock) -->
                <div class="bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between mx-1 border border-gray-100">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-sun text-yellow-400 text-3xl"></i>
                        <div>
                            <p class="text-2xl font-bold text-gray-800">24Â°C</p>
                            <p class="text-xs text-gray-400">é«”æ„Ÿ 26Â°C â€¢ æ™´æœ—</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-600">{{ tripData.location }}</p>
                        <p class="text-xs text-gray-400">é™é›¨æ©Ÿç‡ 10%</p>
                    </div>
                </div>

                <!-- è¡Œç¨‹åˆ—è¡¨ (Sortable Container) -->
                <div class="space-y-0 relative pl-4 border-l-2 ml-4 pb-10" :style="{ borderColor: tripData.themeColor.lightHex }">
                    
                    <!-- ç¬¬ä¸€å¤©ä¸”æ˜¯ç¬¬ä¸€å€‹è¡Œç¨‹ï¼šé¡¯ç¤ºå»ç¨‹èˆªç­ -->
                    <div v-if="selectedDateIndex === 0" class="mb-8 relative pl-6">
                         <div class="absolute -left-[25px] top-0 w-8 h-8 rounded-full bg-white border-4 flex items-center justify-center z-10" :style="{ borderColor: tripData.themeColor.hex }">
                            <i class="fas fa-plane text-xs text-gray-400"></i>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                             <div class="flex justify-between items-start mb-2">
                                <span class="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded-full font-bold">å»ç¨‹èˆªç­</span>
                                <span class="text-xs text-gray-400">{{ tripData.flight.outTime }}</span>
                            </div>
                            <h3 class="font-bold text-gray-800">{{ tripData.flight.outAirline }} {{ tripData.flight.outCode }}</h3>
                            <p class="text-xs text-gray-500 mt-1">å¾ TPE å‡ºç™¼å‰å¾€ {{ tripData.location }}</p>
                        </div>
                        <!-- äº¤é€šæ™‚é–“ (å¾èˆªç­åˆ°ä¸‹ä¸€å€‹é») -->
                        <div v-if="currentDayItinerary.length > 0" class="my-4 pl-2 flex items-center text-gray-400 text-xs">
                             <i class="fas fa-taxi mr-2"></i>
                             <span>ç´„ 45 åˆ†é˜ (é ä¼°)</span>
                        </div>
                    </div>

                    <!-- ä¸€èˆ¬è¡Œç¨‹å¡ç‰‡ -->
                    <div ref="sortableList" class="min-h-[100px]">
                        <div v-for="(item, index) in currentDayItinerary" :key="item.id" :data-id="item.id" class="mb-6 relative pl-6 group">
                            <!-- æ™‚é–“è»¸é»é» -->
                            <div class="absolute -left-[25px] top-0 w-8 h-8 rounded-full bg-white border-4 flex items-center justify-center z-10 transition-colors" :style="{ borderColor: tripData.themeColor.hex }">
                                <i :class="getCategoryIcon(item.category)" class="text-xs text-gray-500"></i>
                            </div>

                            <!-- å¡ç‰‡æœ¬é«” -->
                            <div @click="openGoogleMaps(item.name)" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-98 transition-transform cursor-pointer relative overflow-hidden">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide opacity-80" :class="getCategoryColor(item.category)">{{ item.category }}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-400">{{ item.time || '--:--' }}</span>
                                        <button @click.stop="deleteItem(item.id)" class="text-gray-300 hover:text-red-400 p-1"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                                <p v-if="item.note" class="text-xs text-gray-500 mt-2 line-clamp-2"><i class="far fa-sticky-note mr-1"></i>{{ item.note }}</p>
                                
                                <div v-if="item.category === 'æ™¯é»' || item.category === 'é«”é©—'" class="mt-2 flex gap-2">
                                    <span v-if="item.ticket" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">ğŸ« {{ item.ticket }}</span>
                                </div>
                            </div>

                            <!-- äº¤é€šæ™‚é–“ (åˆ°ä¸‹ä¸€å€‹é») -->
                            <div v-if="index < currentDayItinerary.length - 1" class="my-4 pl-2 flex items-center text-gray-400 text-xs cursor-pointer hover:text-gray-600" @click="toggleTransport(index)">
                                <i :class="getTransportIcon(item.nextTransport)" class="mr-2"></i>
                                <span>{{ item.nextTransportTime || '15' }} åˆ†é˜</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æœ€å¾Œä¸€å¤©ä¸”æœ€å¾Œä¸€å€‹ï¼šå›ç¨‹èˆªç­ -->
                    <div v-if="selectedDateIndex === dayList.length -1 && currentDayItinerary.length > 0" class="mt-8 relative pl-6 opacity-80">
                         <div class="my-4 pl-2 flex items-center text-gray-400 text-xs">
                             <i class="fas fa-subway mr-2"></i>
                             <span>å‰å¾€æ©Ÿå ´</span>
                        </div>
                        <div class="absolute -left-[25px] top-8 w-8 h-8 rounded-full bg-white border-4 flex items-center justify-center z-10" :style="{ borderColor: tripData.themeColor.hex }">
                            <i class="fas fa-plane-departure text-xs text-gray-400"></i>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 border-dashed">
                             <div class="flex justify-between items-start mb-2">
                                <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-1 rounded-full font-bold">å›ç¨‹èˆªç­</span>
                                <span class="text-xs text-gray-400">{{ tripData.flight.retTime }}</span>
                            </div>
                            <h3 class="font-bold text-gray-700">{{ tripData.flight.retAirline }} {{ tripData.flight.retCode }}</h3>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 2. è³‡è¨Š View -->
            <div v-else-if="currentTab === 'info'" class="p-5 space-y-6">
                <!-- åŒ¯ç‡æ›ç®— -->
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-coins mr-2 text-yellow-500"></i> åŒ¯ç‡æ›ç®—</h3>
                    <div class="flex items-end gap-3 mb-2">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 mb-1 block">å¤–å¹£</label>
                            <input type="number" v-model="info.calcAmount" class="w-full text-2xl font-bold border-b-2 border-gray-200 focus:border-gray-500 outline-none py-1" placeholder="0">
                        </div>
                        <i class="fas fa-exchange-alt text-gray-300 mb-3"></i>
                        <div class="flex-1 text-right">
                             <label class="text-xs text-gray-400 mb-1 block">å°å¹£ (TWD)</label>
                             <div class="text-2xl font-bold text-gray-800 py-1">{{ calculatedTwd }}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2 bg-gray-50 p-2 rounded-lg">
                        <span class="text-xs text-gray-500">è¨­å®šåŒ¯ç‡ (1å¤–å¹£ = ? å°å¹£)</span>
                        <input type="number" v-model="info.exchangeRate" class="w-20 text-right bg-transparent border-b border-gray-300 text-sm font-bold text-gray-500 focus:outline-none">
                    </div>
                </div>

                <!-- è³‡è¨Šå¡ç‰‡çµ„ -->
                <div class="grid gap-4">
                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-blue-400">
                        <h4 class="font-bold text-gray-700 mb-2">âœˆï¸ èˆªç­è³‡è¨Š</h4>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p>å»ï¼š{{ tripData.flight.outAirline }} {{ tripData.flight.outCode }} ({{ tripData.flight.outTime }})</p>
                            <p>å›ï¼š{{ tripData.flight.retAirline }} {{ tripData.flight.retCode }} ({{ tripData.flight.retTime }})</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-purple-400">
                        <h4 class="font-bold text-gray-700 mb-2">ğŸ¨ ä½å®¿è³‡è¨Š</h4>
                         <input v-model="tripData.hotel.name" placeholder="è¼¸å…¥é£¯åº—åç¨±" class="w-full mb-2 text-sm border-b border-gray-200 focus:outline-none py-1">
                         <input v-model="tripData.hotel.address" placeholder="è¼¸å…¥é£¯åº—åœ°å€" class="w-full mb-2 text-sm text-gray-500 border-b border-gray-200 focus:outline-none py-1">
                         <button @click="openGoogleMaps(tripData.hotel.name + ' ' + tripData.hotel.address)" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i>å°èˆª</button>
                    </div>

                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-red-400">
                        <h4 class="font-bold text-gray-700 mb-2">ğŸš‘ ç·Šæ€¥è¯çµ¡</h4>
                        <div class="flex gap-2">
                             <div class="flex-1 bg-red-50 p-2 rounded text-center">
                                 <span class="block text-xs text-red-400">è­¦å¯Ÿ</span>
                                 <span class="font-bold text-red-600">110</span>
                             </div>
                             <div class="flex-1 bg-red-50 p-2 rounded text-center">
                                 <span class="block text-xs text-red-400">æ•‘è­·è»Š</span>
                                 <span class="font-bold text-red-600">119</span>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. è³¼ç‰©æ¸…å–® View -->
            <div v-else-if="currentTab === 'shopping'" class="p-4">
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="item in shoppingList" :key="item.id" class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 relative group">
                        <button @click="deleteShoppingItem(item.id)" class="absolute top-2 right-2 bg-white/80 rounded-full w-6 h-6 flex items-center justify-center text-red-400 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        <div class="h-32 bg-gray-100 overflow-hidden">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-300">
                                <i class="fas fa-image text-2xl"></i>
                            </div>
                        </div>
                        <div class="p-3">
                            <h4 class="font-bold text-gray-800 text-sm truncate">{{ item.name }}</h4>
                            <p class="text-xs text-gray-400 mt-1">ç´„ {{ item.price || 0 }} TWD</p>
                            <div class="mt-2 flex items-center gap-1">
                                <input type="checkbox" v-model="item.checked" class="rounded text-[var(--theme-color)]">
                                <span class="text-xs text-gray-500" :class="{'line-through': item.checked}">å·²è²·</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="shoppingList.length === 0" class="text-center mt-20 text-gray-400">
                    <i class="fas fa-shopping-basket text-4xl mb-3 opacity-30"></i>
                    <p>é‚„æ²’æœ‰æƒ³è²·çš„æ±è¥¿?</p>
                </div>
            </div>

             <!-- 4. èŠ±è²» View -->
            <div v-else-if="currentTab === 'expenses'" class="p-4 space-y-4">
                <!-- ç¸½èŠ±è²»æ¦‚è¦½ -->
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 text-center">
                    <p class="text-xs text-gray-400 mb-1">Total Expenses</p>
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">
                        <span class="text-sm align-top text-gray-400">TWD</span> {{ totalExpenseTwd.toLocaleString() }}
                    </h2>
                    <div class="flex justify-center gap-4 text-xs text-gray-500">
                        <span>å¤–å¹£ç¸½è¨ˆ: {{ totalExpenseForeign.toLocaleString() }}</span>
                        <span>|</span>
                        <span>åŒ¯ç‡: {{ info.exchangeRate }}</span>
                    </div>
                </div>

                <!-- é¡åˆ¥ç¯©é¸ -->
                <div class="flex overflow-x-auto gap-2 pb-2 hide-scrollbar">
                    <button @click="expenseFilter = 'all'" :class="expenseFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 border'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors">å…¨éƒ¨</button>
                    <button v-for="cat in expenseCategories" :key="cat" 
                        @click="expenseFilter = cat"
                        :class="expenseFilter === cat ? 'theme-bg text-white' : 'bg-white text-gray-500 border'"
                        :style="expenseFilter === cat ? { backgroundColor: tripData.themeColor.hex } : {}"
                        class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors">
                        {{ cat }}
                    </button>
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="space-y-3 pb-20">
                    <div v-for="exp in filteredExpenses" :key="exp.id" class="bg-white rounded-2xl p-4 flex items-center justify-between shadow-sm border border-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-xl">
                                {{ getExpenseIcon(exp.category) }}
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700 text-sm">{{ exp.name }}</h4>
                                <p class="text-xs text-gray-400">{{ exp.date }} â€¢ {{ exp.payment }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-gray-800">{{ parseInt(exp.amountTwd).toLocaleString() }} <span class="text-[10px] text-gray-400">TWD</span></p>
                             <p v-if="exp.amountForeign > 0" class="text-xs text-gray-400">{{ exp.amountForeign }} å¤–å¹£</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- + æŒ‰éˆ• (Floating Action Button) -->
        <button @click="openAddModal" class="absolute bottom-6 right-6 w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-white text-2xl z-30 transform hover:scale-105 transition active:scale-95" :style="{ backgroundColor: tripData.themeColor.hex }">
            <i class="fas fa-plus"></i>
        </button>

        <!-- ================= æ–°å¢/ç·¨è¼¯ Modal ================= -->
        <div v-if="showAddModal" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-md rounded-t-[30px] sm:rounded-3xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                
                <h3 class="text-xl font-bold text-gray-800 mb-6">æ–°å¢ {{ tabNameMap[currentTab] }}</h3>

                <!-- 1. æ–°å¢è¡Œç¨‹è¡¨å–® -->
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                         <select v-model="newItem.itinerary.category" class="p-3 bg-gray-50 rounded-xl border-none outline-none">
                             <option v-for="cat in itineraryCategories" :value="cat">{{ cat }}</option>
                         </select>
                         <input v-model="newItem.itinerary.time" type="time" class="p-3 bg-gray-50 rounded-xl border-none outline-none">
                    </div>
                    <input v-model="newItem.itinerary.name" placeholder="åç¨± (ä¾‹ï¼šæ¸…æ°´å¯º)" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none text-lg font-bold">
                    <input v-model="newItem.itinerary.ticket" placeholder="é–€ç¥¨/åƒ¹æ ¼" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none">
                    <textarea v-model="newItem.itinerary.note" placeholder="å‚™è¨» (é ç´„è™Ÿç¢¼ã€å¿…è²·...)" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none h-24"></textarea>
                </div>

                <!-- 2. æ–°å¢è³¼ç‰©è¡¨å–® -->
                <div v-if="currentTab === 'shopping'" class="space-y-4">
                    <input v-model="newItem.shopping.name" placeholder="å•†å“åç¨±" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none font-bold">
                    <input v-model="newItem.shopping.price" type="number" placeholder="é ä¼°é‡‘é¡ (TWD)" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none">
                    
                    <!-- åœ–ç‰‡ä¸Šå‚³ -->
                    <div class="relative w-full h-32 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:bg-gray-50">
                        <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                        <img v-if="newItem.shopping.image" :src="newItem.shopping.image" class="w-full h-full object-cover rounded-xl">
                        <div v-else class="text-center text-gray-400">
                            <i class="fas fa-camera text-2xl mb-1"></i>
                            <p class="text-xs">é»æ“Šä¸Šå‚³ç…§ç‰‡</p>
                        </div>
                    </div>
                </div>

                 <!-- 3. æ–°å¢èŠ±è²»è¡¨å–® -->
                <div v-if="currentTab === 'expenses'" class="space-y-4">
                    <input v-model="newItem.expense.name" placeholder="é …ç›®åç¨±" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none font-bold">
                    <div class="grid grid-cols-2 gap-3">
                        <select v-model="newItem.expense.category" class="p-3 bg-gray-50 rounded-xl border-none outline-none">
                             <option v-for="cat in expenseCategories" :value="cat">{{ cat }}</option>
                         </select>
                         <select v-model="newItem.expense.payment" class="p-3 bg-gray-50 rounded-xl border-none outline-none">
                             <option value="ç¾é‡‘">ç¾é‡‘</option>
                             <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                             <option value="å…¬è²»">å…¬è²»</option>
                         </select>
                    </div>
                    
                    <!-- é‡‘é¡é‚è¼¯ -->
                    <div class="bg-gray-50 p-4 rounded-xl space-y-3">
                         <div v-if="newItem.expense.payment !== 'ä¿¡ç”¨å¡'" class="flex items-center gap-2">
                             <span class="text-sm text-gray-500 w-12">å¤–å¹£</span>
                             <input v-model="newItem.expense.amountForeign" type="number" placeholder="è¼¸å…¥é‡‘é¡" class="flex-1 p-2 bg-white rounded border-none outline-none">
                         </div>
                         <div class="flex items-center gap-2">
                             <span class="text-sm text-gray-500 w-12">å°å¹£</span>
                             <input v-model="newItem.expense.amountTwd" type="number" :placeholder="newItem.expense.payment === 'ä¿¡ç”¨å¡' ? 'è‡ªè¡Œè¼¸å…¥ä¿¡ç”¨å¡é‡‘é¡' : 'è‡ªå‹•æ›ç®—'" :readonly="newItem.expense.payment !== 'ä¿¡ç”¨å¡'" class="flex-1 p-2 bg-white rounded border-none outline-none font-bold text-gray-700">
                         </div>
                    </div>
                    
                    <input type="date" v-model="newItem.expense.date" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none">
                </div>

                <div class="flex gap-3 mt-8">
                    <button @click="showAddModal = false" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button>
                    <button @click="confirmAdd" class="flex-1 py-3 text-white rounded-xl font-bold shadow-lg" :style="{ backgroundColor: tripData.themeColor.hex }">ç¢ºèªæ–°å¢</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- è³‡æ–™ç‹€æ…‹ ---
            const showSetupModal = ref(true);
            const currentStep = ref(0);
            const currentTab = ref('itinerary');
            const showAddModal = ref(false);
            const selectedDateIndex = ref(0);
            
            // è«è˜­è¿ªè‰²ç³»è¡¨
            const colorOptions = [
                { name: 'Dusty Red', hex: '#b5838d', lightHex: '#ffccd5' },
                { name: 'Sage Green', hex: '#84a98c', lightHex: '#cad2c5' },
                { name: 'Muted Blue', hex: '#6d6875', lightHex: '#e5989b' }, // Purple tint
                { name: 'Steel Blue', hex: '#457b9d', lightHex: '#a8dadc' },
                { name: 'Earth Brown', hex: '#a98467', lightHex: '#ddb892' },
                { name: 'Warm Orange', hex: '#e76f51', lightHex: '#f4a261' },
                { name: 'Olive', hex: '#606c38', lightHex: '#fefae0' },
                { name: 'Mustard', hex: '#e9c46a', lightHex: '#ffe8d6' },
                { name: 'Charcoal', hex: '#264653', lightHex: '#2a9d8f' },
                { name: 'Ash Grey', hex: '#6c757d', lightHex: '#adb5bd' },
            ];

            // åˆå§‹è¨­å®šè³‡æ–™
            const setupSteps = [
                { title: 'é€™æ¬¡è¦å»å“ªè£¡ç©ï¼Ÿ' },
                { title: 'æ—¥æœŸé¸å®š' },
                { title: 'èˆªç­è³‡è¨Š' },
                { title: 'é¸æ“‡ä¸»é¡Œè‰²' }
            ];

            const tempData = reactive({
                location: '',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0],
                themeColor: colorOptions[1], // default Sage Green
                flight: { outAirline: '', outCode: '', outTime: '', retAirline: '', retCode: '', retTime: '' },
                hotel: { name: '', address: '' }
            });

            // æ ¸å¿ƒè³‡æ–™ (ç¢ºèªå¾Œå¯«å…¥)
            const tripData = reactive({
                location: 'Loading...',
                startDate: '',
                endDate: '',
                themeColor: colorOptions[1],
                flight: {},
                hotel: {}
            });

            // è³‡è¨Š & åŒ¯ç‡
            const info = reactive({
                exchangeRate: 0.23, // é è¨­
                calcAmount: '',
            });

            // è³‡æ–™åº«
            const itineraryData = ref([]); // çµæ§‹: [{ date: '2025-08-06', items: [] }]
            const shoppingList = ref([]);
            const expenseList = ref([]);

            // æ–°å¢æš«å­˜å€
            const newItem = reactive({
                itinerary: { category: 'æ™¯é»', name: '', time: '', ticket: '', note: '' },
                shopping: { name: '', price: '', image: null, checked: false },
                expense: { name: '', category: 'é£²é£Ÿ', payment: 'ç¾é‡‘', amountForeign: '', amountTwd: '', date: '' }
            });

            // é¸é …å¸¸æ•¸
            const tabs = [
                { id: 'itinerary', icon: 'fas fa-map-marked-alt' },
                { id: 'info', icon: 'fas fa-info-circle' },
                { id: 'shopping', icon: 'fas fa-shopping-basket' },
                { id: 'expenses', icon: 'fas fa-wallet' }
            ];
            const tabNameMap = { itinerary: 'è¡Œç¨‹', shopping: 'è³¼ç‰©', expenses: 'èŠ±è²»' };
            const itineraryCategories = ['æ™¯é»', 'ç¾é£Ÿ', 'è³¼ç‰©', 'é«”é©—', 'å…¶ä»–'];
            const expenseCategories = ['æ©Ÿç¥¨', 'ä½å®¿', 'äº¤é€š', 'é£²é£Ÿ', 'é–€ç¥¨', 'è³¼ç‰©', 'ä¼´æ‰‹ç¦®', 'å…¶ä»–'];
            
            // --- åˆå§‹åŒ–èˆ‡é‚è¼¯ ---

            // Step Logic
            const nextStep = () => {
                if (currentStep.value < 3) {
                    currentStep.value++;
                } else {
                    // å®Œæˆè¨­å®š
                    Object.assign(tripData, JSON.parse(JSON.stringify(tempData)));
                    generateDayList();
                    showSetupModal.value = false;
                    saveToLocal();
                }
            };

            const openSettings = () => {
                Object.assign(tempData, JSON.parse(JSON.stringify(tripData)));
                currentStep.value = 0;
                showSetupModal.value = true;
            }

            // æ—¥æœŸç”Ÿæˆé‚è¼¯
            const dayList = ref([]);
            const generateDayList = () => {
                dayList.value = [];
                let start = new Date(tripData.startDate);
                let end = new Date(tripData.endDate);
                
                // ç”¢ç”Ÿæ—¥æœŸé™£åˆ—
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                    
                    dayList.value.push({
                        fullDate: dateStr,
                        dayNum: `${d.getMonth() + 1}/${d.getDate()}`,
                        weekDay: days[d.getDay()]
                    });

                    // è‹¥è©²æ—¥æœŸåœ¨ itineraryData å°šç„¡è³‡æ–™ï¼Œå‰‡åˆå§‹åŒ–
                    if (!itineraryData.value.find(i => i.date === dateStr)) {
                        itineraryData.value.push({ date: dateStr, items: [] });
                    }
                }
                // æ’åºç¢ºä¿è³‡æ–™èˆ‡æ—¥æœŸå°é½Š
                itineraryData.value.sort((a,b) => new Date(a.date) - new Date(b.date));
            };

            // å–å¾—ç•¶å‰é¸å®šæ—¥æœŸçš„è¡Œç¨‹
            const currentDayItinerary = computed(() => {
                if (dayList.value.length === 0) return [];
                const dateStr = dayList.value[selectedDateIndex.value].fullDate;
                const data = itineraryData.value.find(i => i.date === dateStr);
                return data ? data.items : [];
            });

            // æ‹–æ›³æ’åºæ›è¼‰
            const sortableList = ref(null);
            let sortableInstance = null;

            watch([currentTab, selectedDateIndex], async () => {
                if (currentTab.value === 'itinerary') {
                    await nextTick();
                    if (sortableList.value) {
                        if (sortableInstance) sortableInstance.destroy();
                        sortableInstance = new Sortable(sortableList.value, {
                            animation: 150,
                            handle: '.group', // æ•´å€‹å¡ç‰‡å¯æ‹–æ›³
                            onEnd: (evt) => {
                                // æ›´æ–°è³‡æ–™é †åº
                                const dateStr = dayList.value[selectedDateIndex.value].fullDate;
                                const dayData = itineraryData.value.find(i => i.date === dateStr);
                                const item = dayData.items.splice(evt.oldIndex, 1)[0];
                                dayData.items.splice(evt.newIndex, 0, item);
                                saveToLocal();
                            }
                        });
                    }
                }
            });

            // --- åŠŸèƒ½å‡½å¼ ---

            const openAddModal = () => {
                if(currentTab.value === 'info') return;
                // é‡ç½®è¡¨å–®
                newItem.itinerary.time = ''; newItem.itinerary.name = ''; newItem.itinerary.note = '';
                newItem.shopping.name = ''; newItem.shopping.price = ''; newItem.shopping.image = null;
                newItem.expense.name = ''; newItem.expense.amountForeign = ''; newItem.expense.amountTwd = '';
                newItem.expense.date = dayList.value[selectedDateIndex.value]?.fullDate || tripData.startDate;
                showAddModal.value = true;
            };

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => newItem.shopping.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };

            const confirmAdd = () => {
                if (currentTab.value === 'itinerary') {
                    const dateStr = dayList.value[selectedDateIndex.value].fullDate;
                    const dayData = itineraryData.value.find(i => i.date === dateStr);
                    dayData.items.push({
                        id: Date.now(),
                        ...JSON.parse(JSON.stringify(newItem.itinerary)),
                        nextTransport: 'taxi', // é è¨­
                        nextTransportTime: '15'
                    });
                    // æ™‚é–“æ’åº
                    dayData.items.sort((a,b) => a.time.localeCompare(b.time));
                } else if (currentTab.value === 'shopping') {
                    shoppingList.value.push({ id: Date.now(), ...JSON.parse(JSON.stringify(newItem.shopping)) });
                } else if (currentTab.value === 'expenses') {
                    expenseList.value.push({ id: Date.now(), ...JSON.parse(JSON.stringify(newItem.expense)) });
                }
                showAddModal.value = false;
                saveToLocal();
            };

            const deleteItem = (id) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) {
                    const dateStr = dayList.value[selectedDateIndex.value].fullDate;
                    const dayData = itineraryData.value.find(i => i.date === dateStr);
                    dayData.items = dayData.items.filter(i => i.id !== id);
                    saveToLocal();
                }
            };
             
            const deleteShoppingItem = (id) => {
                shoppingList.value = shoppingList.value.filter(i => i.id !== id);
                saveToLocal();
            }

            const toggleTransport = (index) => {
                // ç°¡å–®åˆ‡æ›äº¤é€šåœ–ç¤º
                const dateStr = dayList.value[selectedDateIndex.value].fullDate;
                const items = itineraryData.value.find(i => i.date === dateStr).items;
                const modes = ['walking', 'car', 'bus', 'taxi'];
                const current = items[index].nextTransport || 'taxi';
                const next = modes[(modes.indexOf(current) + 1) % modes.length];
                items[index].nextTransport = next;
            };

            const openGoogleMaps = (query) => {
                if(!query) return;
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
            };

            // --- Computed Helper ---
            
            const formatDateRange = computed(() => {
                if (!tripData.startDate) return '';
                const s = new Date(tripData.startDate);
                const e = new Date(tripData.endDate);
                return `${s.getFullYear()}.${s.getMonth()+1}.${s.getDate()} - ${e.getMonth()+1}.${e.getDate()}`;
            });

            const calculatedTwd = computed(() => {
                if (!info.calcAmount) return 0;
                return Math.round(info.calcAmount * info.exchangeRate);
            });

            // Expense Watcher: Auto calculate TWD
            watch(() => newItem.expense.amountForeign, (val) => {
                if (newItem.expense.payment !== 'ä¿¡ç”¨å¡' && val) {
                    newItem.expense.amountTwd = Math.round(val * info.exchangeRate);
                }
            });

            // Expense Filtering
            const expenseFilter = ref('all');
            const filteredExpenses = computed(() => {
                if (expenseFilter.value === 'all') return expenseList.value;
                return expenseList.value.filter(e => e.category === expenseFilter.value);
            });

            const totalExpenseTwd = computed(() => {
                return filteredExpenses.value.reduce((sum, item) => sum + Number(item.amountTwd || 0), 0);
            });
            const totalExpenseForeign = computed(() => {
                return filteredExpenses.value.reduce((sum, item) => sum + Number(item.amountForeign || 0), 0);
            });

            // --- Helpers UI ---
            const getCategoryColor = (cat) => {
                const map = { 'æ™¯é»': 'bg-green-100 text-green-600', 'ç¾é£Ÿ': 'bg-orange-100 text-orange-600', 'è³¼ç‰©': 'bg-pink-100 text-pink-600', 'é«”é©—': 'bg-blue-100 text-blue-600' };
                return map[cat] || 'bg-gray-100 text-gray-600';
            };
            const getCategoryIcon = (cat) => {
                const map = { 'æ™¯é»': 'fas fa-map-marker-alt', 'ç¾é£Ÿ': 'fas fa-utensils', 'è³¼ç‰©': 'fas fa-shopping-bag', 'é«”é©—': 'fas fa-camera' };
                return map[cat] || 'fas fa-circle';
            };
            const getTransportIcon = (type) => {
                const map = { 'walking': 'fas fa-walking', 'car': 'fas fa-car', 'bus': 'fas fa-bus', 'taxi': 'fas fa-taxi' };
                return map[type] || 'fas fa-taxi';
            };
            const getExpenseIcon = (cat) => {
                const map = { 'æ©Ÿç¥¨': 'âœˆï¸', 'ä½å®¿': 'ğŸ¨', 'äº¤é€š': 'ğŸš•', 'é£²é£Ÿ': 'ğŸœ', 'è³¼ç‰©': 'ğŸ›ï¸' };
                return map[cat] || 'ğŸ’°';
            }

            // --- Storage ---
            const saveToLocal = () => {
                const data = { tripData, itineraryData: itineraryData.value, shoppingList: shoppingList.value, expenseList: expenseList.value, info };
                localStorage.setItem('travelMoodApp', JSON.stringify(data));
            };

            onMounted(() => {
                const saved = localStorage.getItem('travelMoodApp');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(tripData, parsed.tripData);
                    Object.assign(info, parsed.info);
                    itineraryData.value = parsed.itineraryData;
                    shoppingList.value = parsed.shoppingList;
                    expenseList.value = parsed.expenseList;
                    showSetupModal.value = false;
                    generateDayList(); // Refresh dates
                }
            });

            return {
                showSetupModal, setupSteps, currentStep, nextStep, tempData, tripData, colorOptions,
                tabs, currentTab, tabNameMap,
                dayList, selectedDateIndex, currentDayItinerary,
                sortableList,
                showAddModal, openAddModal, newItem, confirmAdd, handleImageUpload, deleteItem, deleteShoppingItem,
                info, calculatedTwd,
                expenseCategories, itineraryCategories,
                expenseList, expenseFilter, filteredExpenses, totalExpenseTwd, totalExpenseForeign,
                getCategoryColor, getCategoryIcon, getTransportIcon, getExpenseIcon, toggleTransport, openGoogleMaps,
                formatDateRange, openSettings
            };
        }
    }).mount('#app');
</script>
</body>
</html>

